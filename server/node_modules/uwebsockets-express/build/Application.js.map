{
  "version": 3,
  "sources": ["../src/Application.ts"],
  "sourcesContent": ["import uWS from \"uWebSockets.js\";\nimport EventEmitter from \"events\";\nimport express, { NextFunction, application } from \"express\";\n\n// import pathToRegexp from \"path-to-regexp\";\n\nimport { IncomingMessage } from \"./IncomingMessage.js\";\nimport { ServerResponse } from \"./ServerResponse.js\";\n\nfunction onAbort(req: IncomingMessage, res: ServerResponse) {\n  req.socket.readable = false;\n  res.finished = true;\n  res.aborted = true;\n}\n\ntype RequestHandler = (req: IncomingMessage, res: ServerResponse, next?: NextFunction) => void;\n\nexport type RenderCallback = (e: any, rendered?: string) => void;\ntype EngineCallback = (path: string, options: object, callback: RenderCallback) => void;\n\n// const rootRegexpPath = pathToRegexp(\"/\", [], { end: false, strict: false });\n\nexport type ApplicationOptions = { readBodyMaxTime?: number }\nexport class Application extends EventEmitter {\n\n  // engines: {[ext: string]: EngineCallback} = {};\n  // settings: {[setting: string]: any} = {};\n  // cache: {[id: string]: any} = {};\n\n  protected listeningSocket: any = undefined;\n\n  protected request = express.request;\n  protected response = express.response;\n\n  private _router: any;\n\n  constructor(protected uWSApp: uWS.TemplatedApp, public opts?: ApplicationOptions) {\n    super();\n\n    // Alias app.delete() = app.del()\n    uWSApp['delete'] = uWSApp['del'];\n\n    this.init();\n  }\n\n  protected init() {\n    // perform original express initialization\n    application.init.apply(this, arguments);\n\n    this.uWSApp.any(\"/*\", async (uwsResponse, uwsRequest) => {\n      const url = uwsRequest.getUrl();\n\n      const req = new IncomingMessage(uwsRequest, uwsResponse, [], this);\n      const res = new ServerResponse(uwsResponse, req, this);\n\n      uwsResponse.onAborted(onAbort.bind(undefined, req, res));\n\n      // read body data!\n      if (req.headers['content-length']) {\n        try {\n          await req['readBody']();\n        } catch (e) {\n          console.warn(\"uWebSockets-express: failed reading request body at\", url);\n        }\n      }\n\n      this.handle(req, res);\n    });\n  }\n\n  protected handle(req, res, callback?) {\n    (express.application as any).handle.call(this, req, res, callback);\n  }\n\n  protected lazyrouter() {\n    // DISCARDED: original lazyrouter auto-initializes \"expressInit\", which\n    // overrides the prototype of request/response, which we can't let happen\n    // (express.application as any).lazyrouter.apply(this, arguments);\n\n    if (!this._router) {\n      this._router = express.Router({\n        caseSensitive: this.enabled('case sensitive routing'),\n        strict: this.enabled('strict routing')\n      });\n\n      this._router.use(express.query(this.get('query parser fn')));\n\n      const app = this;\n      this._router.use(function expressInit(req, res, next) {\n        if (app.enabled('x-powered-by')) res.setHeader('X-Powered-By', 'Express');\n        req.res = res;\n        res.req = req;\n        req.next = next;\n\n        // setPrototypeOf(req, app.request)\n        // setPrototypeOf(res, app.response)\n\n        res.locals = res.locals || Object.create(null);\n\n        next();\n      });\n    }\n\n    return ;\n  }\n\n  public engine(ext: string, fn: EngineCallback) {\n    application.engine.apply(this, arguments);\n  }\n\n  public set(setting, val) {\n    return application.set.apply(this, arguments);\n  }\n\n  public enable(setting: string) {\n    return application.enable.call(this, setting);\n  }\n\n  public enabled(setting: string) {\n    return application.enabled.call(this, setting);\n  }\n\n  public render(name: string, options: any, callback: RenderCallback) {\n    return application.render.apply(this, arguments);\n  }\n\n  public use(handler: RequestHandler)\n  public use(path: string, handler: RequestHandler)\n  public use(path: string, router: express.Router)\n  public use(path: string, ...handlers: Array<express.Router | RequestHandler>)\n  public use(path: string, any: any)\n  public use(any: any)\n  public use(pathOrHandler: string | RequestHandler, ...handlersOrRouters: Array<RequestHandler | express.Router>) {\n    express.application.use.apply(this, arguments);\n    return this;\n  }\n\n  public get(path: string, ...handlers: RequestHandler[]) {\n    return express.application.get.apply(this, arguments);\n  }\n\n  public post(path: string, ...handlers: RequestHandler[]) {\n    express.application.post.apply(this, arguments);\n    return this;\n  }\n\n  public patch(path: string, ...handlers: RequestHandler[]) {\n    express.application.patch.apply(this, arguments);\n    return this;\n  }\n\n  public options(path: string, ...handlers: RequestHandler[]) {\n    express.application.options.apply(this, arguments);\n    return this;\n  }\n\n  public put(path: string, ...handlers: RequestHandler[]) {\n    express.application.put.apply(this, arguments);\n    return this;\n  }\n\n  /**\n   * @deprecated\n   */\n  public del(path: string, ...handlers: RequestHandler[]) {\n    return this.delete.apply(this, arguments);\n  }\n\n  public delete(path: string, ...handlers: RequestHandler[]) {\n    express.application.delete.apply(this, arguments);\n    return this;\n  }\n\n  public head(path: string, ...handlers: RequestHandler[]) {\n    express.application.head.apply(this, arguments);\n    return this;\n  }\n\n  public all(path: string, ...handlers: RequestHandler[]) {\n    express.application.all.apply(this, arguments);\n    return this;\n  }\n\n  public listen(port?: number, cb?: () => void) {\n    this.uWSApp.listen(port, (listenSocket: any) => {\n      this.listeningSocket = listenSocket;\n      cb?.();\n    });\n\n    const self = this;\n    return {\n      close() {\n        uWS.us_listen_socket_close(self.listeningSocket);\n        self.listeningSocket = null;\n      }\n    };\n  }\n\n  protected defaultConfiguration() {\n    application.defaultConfiguration.apply(this);\n  }\n\n}\n\n"],
  "mappings": "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",
  "names": ["EventEmitter", "express", "uWS"]
}
